{% extends 'streamer/base.html' %}
{% load static %}

{% block head %}
<title>Upload Videos</title>
{% endblock head %}

{% block main_content %}

{% include 'streamer/navbar.html' %}


<style type="text/css">
	.thumbnail_preview {
		width: 200px;
	}

	.btn_thumbnail {
		background: none;
		border: 0;
		padding: 0;
	}

	.d-none {
		display: none;
	}

</style>

<div id='initial_upload'>
	{# 1. BUTTON TO TRIGGER THE ACTION #}
	<button type="button" class="btn btn-primary js-upload-video">
	  <span class="glyphicon glyphicon-cloud-upload"></span> Upload video
	</button>

	{# 2. FILE INPUT TO BE USED BY THE PLUG-IN #}
	<input id="fileupload" type="file" name="file"
	       style="display: none;"
	       data-url="{% url 'streamer:upload' %}"
	       data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}'>
	{{ form.category }}
</div>

<div id='edit_upload' class="d-none">
	<h1>EDIT TITLE AND SHIT</h1>
	<div class="progress">
        <div class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
    </div>
	<form enctype="multipart/form-data" name="edit_form" id="edit_form" method="POST" action="">
		{% csrf_token %}
		<input type="hidden" name="watch_id" id="watch_id" value="">
		<input type="file" name="thumbnail" id="thumbnail" style="display: none;">
		<input type="hidden" name="selected_thumbnail" id="selected_thumbnail" value="">
		<div class="form-group">
			<label for=title>Title</label>
			<input type="text" name="title" id="title" class="form-control" value="">
		</div>
		<div class="form-group">
			<label for="description">Description</label>
			<textarea class="form-control" name="description" id="description" rows="5"></textarea>
		</div>
		<button type="submit" class="btn btn-primary btn-publish" disabled>Publish</button>
	</form>
	<div id="thumbnail_container">
		<button id="btn_thumbnail_0" class="btn_thumbnail"><img id="thumbnail_0" class="thumbnail_preview" src="" alt="Thumbnail 0"></button>
		<button id="btn_thumbnail_1" class="btn_thumbnail"><img id="thumbnail_1" class="thumbnail_preview" src="" alt="Thumbnail 1"></button>
		<button id="btn_thumbnail_2" class="btn_thumbnail"><img id="thumbnail_2" class="thumbnail_preview" src="" alt="Thumbnail 2"></button>
	</div>
</div>

{% endblock main_content %}

{%block javascript %}

<script src="{% static 'js/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
<script src="{% static 'js/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
<script src="{% static 'js/jquery-file-upload/jquery.fileupload.js' %}"></script>

<script type="text/javascript">
	$(function () {
	  /* 1. OPEN THE FILE EXPLORER WINDOW */
	  $(".js-upload-video").click(function () {
	    $("#fileupload").click();
	  });

	  /* 2. INITIALIZE THE FILE UPLOAD COMPONENT */
	  $("#fileupload").fileupload({
	    dataType: 'json',
	    start: function (e) {
	    	$('#initial_upload').addClass('d-none');
	        $('#edit_upload').removeClass('d-none');
	    },
	    progressall: function (e, data) {
	    	$('#watch_id').html(data.watch_id)
	        var progress = parseInt(data.loaded / data.total * 100, 10);
	        var strProgress = progress + "%";
	        $(".progress-bar").css({"width": strProgress});
	        $(".progress-bar").text(strProgress);
	    },
	    /* 3. PROCESS THE RESPONSE FROM THE SERVER */
	    done: function (e, data) {
	    	if (data.result.is_valid) {
	    		$('#watch_id').val(data.result.watch_id);
	    		$('.btn-publish').removeAttr('disabled');
	    		$.ajax({
	    			url: '/upload/',
	    			type: 'POST',
	    			data: {
	    				'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
	    				'watch_id' : $('#watch_id').val(),
	    				'get_thumbnail' : true,
	    			},
	    			success: function(response) {
	    				console.log(response);
	    				$.each(response.thumbnails, function(i, val) {
	    					$('#thumbnail_' + i).attr('src', val);
	    				});
	    				$('#selected_thumbnail').val(response.thumbnails[0]);
	    			},
	    		});
	    	}
	    }
	  });

	  $('.btn_thumbnail').click(function () {
	  	console.log($(this).children('img')[0]);
	  	img = $(this).children('img')[0]
	  	$('#selected_thumbnail').val(img.getAttribute('src'));
	  });

	});
</script>

{% endblock javascript %}